<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfinityDrop v4 | Multi-File Ready</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #3b82f6;
            --text: #f1f5f9;
            --success: #22c55e;
            --border: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .app {
            width: 100%;
            max-width: 480px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--primary); text-align: center; }
        .status { text-align: center; font-size: 0.85rem; color: #94a3b8; margin-bottom: 1.5rem; }

        .section { margin-bottom: 1.5rem; }
        label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 0.5rem; }

        input[type="text"] {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background: #475569; cursor: not-allowed; }

        .file-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .file-area:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .file-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        .progress-container { margin-top: 1rem; display: none; }
        .progress-bar { height: 6px; background: #334155; border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.1s; }
        .progress-text { display: flex; justify-content: space-between; font-size: 0.75rem; color: #cbd5e1; }

        .log-box {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #020617;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.7rem;
            color: #94a3b8;
            height: 100px;
            overflow-y: auto;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app">
    <h1>InfinityDrop v4</h1>
    <div class="status" id="status-text">Initializing...</div>

    <div id="panel-connect" class="section">
        <label>Your ID</label>
        <div style="display: flex; gap: 8px; margin-bottom: 1rem;">
            <input type="text" id="my-id" readonly onclick="this.select()">
            <button style="width: auto;" onclick="copyId()">Copy</button>
        </div>

        <label>Partner ID</label>
        <input type="text" id="partner-id" placeholder="Paste ID here">
        <button onclick="connectToPeer()" id="btn-connect">Connect</button>
    </div>

    <div id="panel-transfer" class="section hidden">
        <div class="file-area">
            <input type="file" id="file-input">
            <div style="font-size: 2rem;">ðŸ“‚</div>
            <div id="file-label">Tap to Send File</div>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-text">
                <span id="transfer-msg">Waiting...</span>
                <span id="transfer-pct">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="log-box" id="logs"></div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
    ];

    const peer = new Peer({
        debug: 1,
        secure: true,
        config: { iceServers: iceServers }
    });

    let conn = null;
    let isTransferring = false;

    // Logging Utility
    function log(msg) {
        const box = document.getElementById('logs');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        box.innerHTML += `<div>[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // --- 2. CONNECTION ---
    peer.on('open', (id) => {
        document.getElementById('my-id').value = id;
        document.getElementById('status-text').innerText = "Online - Ready to Connect";
        log("ID Generated.");
    });

    peer.on('connection', (c) => {
        conn = c;
        setupConnection();
        log("Incoming connection...");
    });

    peer.on('error', (err) => {
        log("Error: " + err.type);
        document.getElementById('btn-connect').disabled = false;
        document.getElementById('btn-connect').innerText = "Connect";
    });

    function connectToPeer() {
        const dest = document.getElementById('partner-id').value.trim();
        if(!dest) return alert("Enter an ID");
        
        document.getElementById('btn-connect').disabled = true;
        document.getElementById('btn-connect').innerText = "Connecting...";
        
        conn = peer.connect(dest, { reliable: true }); // Reliable: true ensures TCP-like delivery
        setupConnection();
    }

    function setupConnection() {
        conn.on('open', () => {
            document.getElementById('panel-connect').classList.add('hidden');
            document.getElementById('panel-transfer').classList.remove('hidden');
            document.getElementById('status-text').innerText = "Connected Securely";
            log("Connected to partner.");
        });

        conn.on('data', (data) => handleData(data));
        
        conn.on('close', () => {
            alert("Connection Lost");
            location.reload();
        });
    }

    // --- 3. SEND LOGIC ---
    const CHUNK_SIZE = 16 * 1024; // 16KB

    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        if(isTransferring) return alert("Wait for current transfer to finish");
        
        sendFile(file);
    });

    function sendFile(file) {
        isTransferring = true;
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('file-label').innerText = "Sending: " + file.name;
        
        // 1. Send Header
        conn.send({
            type: 'header',
            name: file.name,
            size: file.size,
            mime: file.type
        });

        log(`Starting send: ${file.name}`);

        const reader = new FileReader();
        let offset = 0;

        reader.onload = (e) => {
            // 2. Send Chunk
            conn.send({
                type: 'chunk',
                data: e.target.result
            });

            offset += e.target.result.byteLength;
            updateUI(offset, file.size, "Sending...");

            if(offset < file.size) {
                readNextChunk();
            } else {
                // 3. Send Finish Flag (Crucial for closing the file on receiver side)
                conn.send({ type: 'end' });
                log("File sent. Resetting...");
                finishTransfer(true);
            }
        };

        const readNextChunk = () => {
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
        };

        readNextChunk();
    }

    // --- 4. RECEIVE LOGIC ---
    let incomingFiles = []; // Buffer
    let incomingMeta = null;
    let receivedSize = 0;

    function handleData(data) {
        if(data.type === 'header') {
            incomingFiles = [];
            receivedSize = 0;
            incomingMeta = data;
            
            isTransferring = true;
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('file-label').innerText = "Receiving: " + data.name;
            log(`Receiving ${data.name}...`);
        
        } else if(data.type === 'chunk') {
            incomingFiles.push(data.data);
            receivedSize += data.data.byteLength;
            updateUI(receivedSize, incomingMeta.size, "Receiving...");
        
        } else if(data.type === 'end') {
            // File is done
            log("Download complete. Saving...");
            saveFile();
            finishTransfer(false);
        }
    }

    function saveFile() {
        const blob = new Blob(incomingFiles, { type: incomingMeta.mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = incomingMeta.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- 5. UTILS & RESET ---
    function updateUI(curr, total, msg) {
        const pct = Math.floor((curr/total)*100);
        document.getElementById('progress-fill').style.width = pct + "%";
        document.getElementById('transfer-pct').innerText = pct + "%";
        document.getElementById('transfer-msg').innerText = msg;
    }

    function finishTransfer(isSender) {
        isTransferring = false;
        
        // Reset UI after short delay
        setTimeout(() => {
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('progress-fill').style.width = "0%";
            document.getElementById('file-label').innerText = "Tap to Send Another File";
            
            // Clear input so same file can be selected again
            document.getElementById('file-input').value = "";
            
            if(isSender) log("Sent successfully.");
            else log("Saved successfully.");
        }, 1500);
    }

    function copyId() {
        const el = document.getElementById('my-id');
        el.select();
        document.execCommand('copy');
    }
</script>
</body>
</html>
